<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Z ID ‚Äî –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä</title>
  <style>
    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --border: #e2e8f0;
      --primary: #4f46e5;
      --dice: #94a3b8;
      --success: #10b981;
      --error: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 520px;
      margin: 0 auto;
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      margin-bottom: 24px;
      border: 1px solid var(--border);
    }

    h1, h2 {
      font-weight: 700;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 28px;
      text-align: center;
      color: var(--primary);
    }

    label {
      display: block;
      margin: 16px 0 8px;
      font-weight: 600;
    }

    .input-group {
      position: relative;
    }

    input, select, button {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--card);
      color: var(--text);
      font-size: 16px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    .dice-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      background: var(--dice);
      color: white;
      border: none;
      border-radius: 50%;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dice-btn:hover {
      background: #64748b;
    }

    .error {
      color: var(--error);
      font-size: 14px;
      margin-top: -12px;
      margin-bottom: 12px;
    }

    .success {
      color: var(--success);
      font-size: 14px;
      margin-top: -12px;
      margin-bottom: 12px;
    }

    button {
      background: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      border: none;
      margin-top: 16px;
      transition: opacity 0.2s;
    }

    button:hover {
      opacity: 0.9;
    }

    button.secondary {
      background: #e2e8f0;
      color: #475569;
    }

    .hidden {
      display: none;
    }

    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      font-weight: 500;
    }

    .tab.active {
      background: var(--primary);
      color: white;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      font-size: 14px;
      color: #64748b;
    }

    /* –ú–µ–Ω—é –ø—Ä–æ—Ñ–∏–ª—è ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    .zid-profile-card {
      max-width: 520px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 28px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: #1e293b;
      border: 1px solid #e2e8f0;
    }

    .zid-header h2 {
      font-weight: 700;
      font-size: 24px;
      margin-bottom: 24px;
      color: #4f46e5;
      text-align: center;
    }

    .zid-row {
      margin-bottom: 20px;
    }

    .zid-row input[type="text"],
    .zid-row input[readonly] {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      font-size: 16px;
      background: #f8fafc;
      color: #1e293b;
    }

    .zid-row input[readonly] {
      background: #f1f5f9;
      cursor: not-allowed;
    }

    .zid-highlight {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .zid-code {
      padding: 10px 16px;
      background: #0f172a;
      color: #60a5fa;
      font-family: 'SF Mono', 'Consolas', monospace;
      font-size: 20px;
      font-weight: 600;
      border-radius: 8px;
      letter-spacing: 2px;
      min-width: 200px;
      text-align: center;
      box-shadow: 0 0 0 2px #3b82f6;
    }

    .zid-copy-btn {
      padding: 10px 16px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .zid-copy-btn:hover {
      background: #2563eb;
    }

    .zid-notice {
      background: #fffbeb;
      border: 1px solid #f59e0b;
      color: #92400e;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      margin-top: 8px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.2); }
      50% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
    }

    .zid-btn, .zid-btn-secondary {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      font-size: 16px;
    }

    .zid-btn {
      background: #4f46e5;
      color: white;
    }

    .zid-btn-secondary {
      background: #e2e8f0;
      color: #475569;
    }

    .zid-password-section {
      position: relative;
    }

    .zid-password-section label {
      position: absolute;
      top: 0;
      left: 0;
    }

    .zid-password-section button {
      margin-top: 28px;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    #passwordModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    #passwordModalContent {
      background: white;
      padding: 28px;
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    #passwordModal h3 {
      margin-bottom: 20px;
      color: #1e293b;
    }

    #passwordModal input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
    }

    #passwordModal .error {
      color: #ef4444;
      font-size: 14px;
      margin: 4px 0;
    }

    #passwordModal .success {
      color: #10b981;
      font-size: 14px;
      margin: 4px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div id="authScreen" class="card">
      <h1>Z ID</h1>

      <div class="tabs">
        <button class="tab active" data-view="login">–í—Ö–æ–¥</button>
        <button class="tab" data-view="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>

      <!-- –í—Ö–æ–¥ -->
      <div id="loginView">
        <label for="loginZID">Z ID (10 —Ü–∏—Ñ—Ä)</label>
        <input type="text" id="loginZID" placeholder="1943228567" maxlength="10" inputmode="numeric" />

        <label for="loginPass">–ü–∞—Ä–æ–ª—å</label>
        <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

        <div id="loginError" class="error hidden"></div>
        <button id="btnLogin">–í–æ–π—Ç–∏</button>
      </div>

      <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
      <div id="registerView" class="hidden">
        <label for="regName">–ò–º—è</label>
        <input type="text" id="regName" placeholder="–ê–ª–µ–∫—Å–∞–Ω–¥—Ä" required />

        <label for="regSurname">–§–∞–º–∏–ª–∏—è</label>
        <input type="text" id="regSurname" placeholder="–ò–≤–∞–Ω–æ–≤" required />

        <label for="regPatronymic">–û—Ç—á–µ—Å—Ç–≤–æ</label>
        <input type="text" id="regPatronymic" placeholder="–°–µ—Ä–≥–µ–µ–≤–∏—á" required />

        <label for="regZID">Z ID (10 —Ü–∏—Ñ—Ä)</label>
        <div class="input-group">
          <input type="text" id="regZID" placeholder="1943228567" maxlength="10" inputmode="numeric" required />
          <button class="dice-btn" id="diceBtn">üé≤</button>
        </div>
        <div class="error hidden" id="zidError"></div>

        <label for="regPass">–ü–∞—Ä–æ–ª—å (8‚Äì20)</label>
        <input type="password" id="regPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8" maxlength="20" required />
        <div class="error hidden" id="passError"></div>

        <label for="regBirth">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
        <input type="date" id="regBirth" required />

        <label for="regNationality">–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</label>
        <select id="regNationality">
          <option value="–†—É—Å—Å–∫–∏–π">–†—É—Å—Å–∫–∏–π</option>
          <option value="–£–∫—Ä–∞–∏–Ω–µ—Ü">–£–∫—Ä–∞–∏–Ω–µ—Ü</option>
          <option value="–ë–µ–ª–æ—Ä—É—Å">–ë–µ–ª–æ—Ä—É—Å</option>
          <option value="–¢–∞—Ç–∞—Ä–∏–Ω">–¢–∞—Ç–∞—Ä–∏–Ω</option>
          <option value="–ß–µ—á–µ–Ω–µ—Ü">–ß–µ—á–µ–Ω–µ—Ü</option>
          <option value="–ê—Ä–º—è–Ω–∏–Ω">–ê—Ä–º—è–Ω–∏–Ω</option>
        </select>

        <label>–ü–æ–ª</label>
        <div style="display:flex;gap:16px;margin-bottom:16px">
          <label><input type="radio" name="gender" value="male" required /> –ú—É–∂—Å–∫–æ–π</label>
          <label><input type="radio" name="gender" value="female" /> –ñ–µ–Ω—Å–∫–∏–π</label>
          <label><input type="radio" name="gender" value="other" /> –î—Ä—É–≥–æ–π</label>
        </div>

        <div id="regError" class="error hidden"></div>
        <button id="btnRegister">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      </div>
    </div>

    <!-- –ú–µ–Ω—é –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏) -->
    <div id="profileMenu" class="zid-profile-card hidden">
      <div class="zid-header">
        <h2>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
      </div>

      <div class="zid-row">
        <label>–õ–∏—á–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (Z ID)</label>
        <div class="zid-highlight">
          <code id="displayZID" class="zid-code">1943228567</code>
          <button id="copyZIDBtn" class="zid-copy-btn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å Z ID">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div class="zid-notice">
          ‚ö†Ô∏è <strong>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–ø–æ–º–Ω–∏—Ç–µ –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç Z ID!</strong><br>
          –û–Ω –Ω—É–∂–µ–Ω –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –±—É–¥—É—â–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö. –ë–µ–∑ –Ω–µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.
        </div>
      </div>

      <div class="zid-row">
        <label>–ò–º—è</label>
        <input type="text" id="editName" value="–ê–ª–µ–∫—Å–∞–Ω–¥—Ä" />
      </div>
      <div class="zid-row">
        <label>–§–∞–º–∏–ª–∏—è</label>
        <input type="text" id="editSurname" value="–ò–≤–∞–Ω–æ–≤" />
      </div>
      <div class="zid-row">
        <label>–û—Ç—á–µ—Å—Ç–≤–æ</label>
        <input type="text" id="editPatronymic" value="–°–µ—Ä–≥–µ–µ–≤–∏—á" />
      </div>
      <div class="zid-row">
        <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
        <input type="text" id="displayBirth" value="15.05.1990" readonly />
      </div>
      <div class="zid-row">
        <label>–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</label>
        <input type="text" id="displayNationality" value="–†—É—Å—Å–∫–∏–π" readonly />
      </div>
      <div class="zid-row">
        <label>–ü–æ–ª</label>
        <input type="text" id="displayGender" value="–ú—É–∂—Å–∫–æ–π" readonly />
      </div>

      <div class="zid-row zid-password-section">
        <label>–ü–∞—Ä–æ–ª—å</label>
        <button id="changePassBtn" class="zid-btn-secondary">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
      </div>

      <div class="zid-row">
        <label>–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</label>
        <button id="exportBtn" class="zid-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ JSON</button>
      </div>
    </div>
  </div>

  <footer>
    &copy; 2025 Z ID System ‚Ä¢ –í—Å–µ –¥–∞–Ω–Ω—ã–µ ‚Äî —Ç–æ–ª—å–∫–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ
  </footer>

  <script>
    // üîë Gist ID ‚Äî –¥–ª—è –±—É–¥—É—â–µ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
    const gistId = "YOUR_GIST_ID_HERE";

    // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
    function showError(id, msg) {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    function validateZID(zid) {
      if (zid.length !== 10 || !/^\d{10}$/.test(zid)) {
        return { valid: false, message: 'Z ID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–æ–≤–Ω–æ 10 —Ü–∏—Ñ—Ä' };
      }
      const counts = {};
      for (let d of zid) {
        counts[d] = (counts[d] || 0) + 1;
        if (counts[d] > 3) {
          return { valid: false, message: '–¶–∏—Ñ—Ä–∞ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è –±–æ–ª–µ–µ 3 —Ä–∞–∑' };
        }
      }
      return { valid: true };
    }

    function generateZID() {
      let zid;
      do {
        zid = '';
        const counts = {};
        for (let i = 0; i < 10; i++) {
          let d;
          do {
            d = Math.floor(Math.random() * 10).toString();
          } while (counts[d] >= 3);
          zid += d;
          counts[d] = (counts[d] || 0) + 1;
        }
      } while (zid.length !== 10);
      return zid;
    }

    async function hashPassword(password, salt = null) {
      if (!salt) {
        const arr = new Uint8Array(32);
        crypto.getRandomValues(arr);
        salt = Array.from(arr, b => b.toString(16).padStart(2, '0')).join('');
      }

      const enc = new TextEncoder();
      const key = await crypto.subtle.importKey(
        'raw', enc.encode(password), { name: 'PBKDF2' }, false, ['deriveBits']
      );

      const bits = await crypto.subtle.deriveBits({
        name: 'PBKDF2',
        salt: enc.encode(salt),
        iterations: 100000,
        hash: 'SHA-256'
      }, key, 256);

      const hashArr = Array.from(new Uint8Array(bits));
      return hashArr.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // === –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ===
    document.getElementById('btnRegister').addEventListener('click', async () => {
      const name = document.getElementById('regName').value.trim();
      const surname = document.getElementById('regSurname').value.trim();
      const patronymic = document.getElementById('regPatronymic').value.trim();
      const zid = document.getElementById('regZID').value.trim();
      const pass = document.getElementById('regPass').value;
      const birth = document.getElementById('regBirth').value;
      const nationality = document.getElementById('regNationality').value;
      const genderEl = document.querySelector('input[name="gender"]:checked');
      const gender = genderEl ? genderEl.value : '';

      if (!name || !surname || !patronymic || !zid || !pass || !birth || !nationality || !gender) {
        showError('regError', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
      }

      const zidCheck = validateZID(zid);
      if (!zidCheck.valid) {
        showError('zidError', zidCheck.message);
        return;
      }

      if (pass.length < 8 || pass.length > 20) {
        showError('passError', '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 8‚Äì20 —Å–∏–º–≤–æ–ª–æ–≤');
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
      for (let key in localStorage) {
        if (key.startsWith('zid_')) {
          try {
            const acc = JSON.parse(localStorage.getItem(key));
            if (acc.zid === zid) {
              showError('zidError', '–≠—Ç–æ—Ç Z ID —É–∂–µ –∑–∞–Ω—è—Ç. –ù–∞–∂–º–∏—Ç–µ üé≤ –¥–ª—è –Ω–æ–≤–æ–≥–æ.');
              return;
            }
          } catch (e) {}
        }
      }

      const salt = Array.from(crypto.getRandomValues(new Uint8Array(32)), b => b.toString(16).padStart(2, '0')).join('');
      const pwd_hash = await hashPassword(pass, salt);

      const account = {
        zid,
        name,
        surname,
        patronymic,
        password_hash: pwd_hash,
        salt,
        birth_date: birth,
        nationality,
        gender: ({male: '–ú—É–∂—Å–∫–æ–π', female: '–ñ–µ–Ω—Å–∫–∏–π', other: '–î—Ä—É–≥–æ–π'})[gender],
        created_at: new Date().toISOString()
      };

      localStorage.setItem(`zid_${zid}`, JSON.stringify(account));
      localStorage.setItem('currentZID', zid);

      showProfile(zid);
    });

    // === –í–•–û–î ===
    document.getElementById('btnLogin').addEventListener('click', async () => {
      const zid = document.getElementById('loginZID').value.trim();
      const pass = document.getElementById('loginPass').value;

      const accountJSON = localStorage.getItem(`zid_${zid}`);
      if (!accountJSON) {
        showError('loginError', '–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
      }

      const acc = JSON.parse(accountJSON);
      const hash = await hashPassword(pass, acc.salt);

      if (hash !== acc.password_hash) {
        showError('loginError', '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
        return;
      }

      localStorage.setItem('currentZID', zid);
      showProfile(zid);
    });

    // === –ú–ï–ù–Æ –ü–†–û–§–ò–õ–Ø ===
    function showProfile(zid) {
      const accountJSON = localStorage.getItem(`zid_${zid}`);
      if (!accountJSON) return;

      const acc = JSON.parse(accountJSON);

      document.getElementById('displayZID').textContent = acc.zid;
      document.getElementById('editName').value = acc.name;
      document.getElementById('editSurname').value = acc.surname;
      document.getElementById('editPatronymic').value = acc.patronymic;
      document.getElementById('displayBirth').value = new Date(acc.birth_date).toLocaleDateString('ru-RU');
      document.getElementById('displayNationality').value = acc.nationality;
      document.getElementById('displayGender').value = acc.gender;

      document.getElementById('authScreen').classList.add('hidden');
      document.getElementById('profileMenu').classList.remove('hidden');

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      document.getElementById('copyZIDBtn').onclick = () => {
        const code = acc.zid;
        navigator.clipboard.writeText(code).then(() => {
          const btn = document.getElementById('copyZIDBtn');
          btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
          setTimeout(() => btn.textContent = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 2000);
        });
      };

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –§–ò–û –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
      ['editName', 'editSurname', 'editPatronymic'].forEach(id => {
        document.getElementById(id).onblur = () => {
          acc.name = document.getElementById('editName').value;
          acc.surname = document.getElementById('editSurname').value;
          acc.patronymic = document.getElementById('editPatronymic').value;
          localStorage.setItem(`zid_${zid}`, JSON.stringify(acc));
        };
      });

      // –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
      document.getElementById('changePassBtn').onclick = () => {
        const modal = `
          <div id="passwordModal">
            <div id="passwordModalContent">
              <h3>–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
              <input type="password" id="oldPass" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å" />
              <input type="password" id="newPass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (8‚Äì20)" />
              <input type="password" id="newPass2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ" />
              <div id="passError" class="error"></div>
              <div id="passSuccess" class="success"></div>
              <button id="savePassBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="cancelPassBtn" class="secondary">–û—Ç–º–µ–Ω–∞</button>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modal);

        document.getElementById('cancelPassBtn').onclick = () => {
          document.getElementById('passwordModal').remove();
        };

        document.getElementById('savePassBtn').onclick = async () => {
          const old = document.getElementById('oldPass').value;
          const new1 = document.getElementById('newPass').value;
          const new2 = document.getElementById('newPass2').value;
          const err = document.getElementById('passError');
          const ok = document.getElementById('passSuccess');

          if (new1 !== new2) {
            err.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
            return;
          }

          if (new1.length < 8 || new1.length > 20) {
            err.textContent = '–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 8‚Äì20 —Å–∏–º–≤–æ–ª–æ–≤';
            return;
          }

          const oldHash = await hashPassword(old, acc.salt);
          if (oldHash !== acc.password_hash) {
            err.textContent = '–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–µ–Ω';
            return;
          }

          const newSalt = Array.from(crypto.getRandomValues(new Uint8Array(32)), b => b.toString(16).padStart(2, '0')).join('');
          const newHash = await hashPassword(new1, newSalt);

          acc.password_hash = newHash;
          acc.salt = newSalt;
          localStorage.setItem(`zid_${zid}`, JSON.stringify(acc));

          ok.textContent = '‚úÖ –ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω';
          setTimeout(() => {
            document.getElementById('passwordModal').remove();
          }, 1500);
        };
      };

      // –≠–∫—Å–ø–æ—Ä—Ç
      document.getElementById('exportBtn').onclick = () => {
        const safe = {
          zid: acc.zid,
          name: acc.name,
          surname: acc.surname,
          patronymic: acc.patronymic,
          birth_date: acc.birth_date,
          nationality: acc.nationality,
          gender: acc.gender,
          created_at: acc.created_at,
          exported_at: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(safe, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `zid_${acc.zid}_backup.json`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 0);
      };
    }

    // === –í–ö–õ–ê–î–ö–ò ===
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('[id$="View"]').forEach(el => el.classList.add('hidden'));
        document.getElementById(tab.dataset.view + 'View').classList.remove('hidden');
      });
    });

    // === –ö–ù–û–ü–ö–ê üé≤ ===
    document.getElementById('diceBtn').onclick = () => {
      let zid;
      do {
        zid = generateZID();
      } while (
        Object.keys(localStorage)
          .filter(k => k.startsWith('zid_'))
          .some(k => {
            try {
              return JSON.parse(localStorage.getItem(k)).zid === zid;
            } catch (e) { return false; }
          })
      );
      document.getElementById('regZID').value = zid;
    };

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    document.addEventListener('DOMContentLoaded', () => {
      const current = localStorage.getItem('currentZID');
      if (current && localStorage.getItem(`zid_${current}`)) {
        showProfile(current);
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Z ID</title>
  <style>
  .zid-profile-card {
  max-width: 520px;
  margin: 0 auto;
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  padding: 28px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  color: #1e293b;
  border: 1px solid #e2e8f0;
}

.zid-header h2 {
  font-weight: 700;
  font-size: 24px;
  margin-bottom: 24px;
  color: #4f46e5;
  text-align: center;
}

.zid-row {
  margin-bottom: 20px;
}

.zid-row label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  font-size: 15px;
}

.zid-row input[type="text"],
.zid-row input[readonly] {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid #cbd5e1;
  border-radius: 10px;
  font-size: 16px;
  background: #f8fafc;
  color: #1e293b;
}

.zid-row input[readonly] {
  background: #f1f5f9;
  cursor: not-allowed;
}

.zid-highlight {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

.zid-code {
  padding: 10px 16px;
  background: #0f172a;
  color: #60a5fa;
  font-family: 'SF Mono', 'Consolas', monospace;
  font-size: 20px;
  font-weight: 600;
  border-radius: 8px;
  letter-spacing: 2px;
  min-width: 200px;
  text-align: center;
  box-shadow: 0 0 0 2px #3b82f6;
}

.zid-copy-btn {
  padding: 10px 16px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
  white-space: nowrap;
}

.zid-copy-btn:hover {
  background: #2563eb;
}

.zid-notice {
  background: #fffbeb;
  border: 1px solid #f59e0b;
  color: #92400e;
  padding: 12px;
  border-radius: 10px;
  font-size: 14px;
  margin-top: 8px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.2); }
  50% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
}

.zid-btn, .zid-btn-secondary {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  font-size: 16px;
  transition: opacity 0.2s;
}

.zid-btn {
  background: #4f46e5;
  color: white;
}

.zid-btn:hover {
  opacity: 0.9;
}

.zid-btn-secondary {
  background: #e2e8f0;
  color: #475569;
}

.zid-password-section {
  position: relative;
}

.zid-password-section label {
  position: absolute;
  top: 0;
  left: 0;
}

.zid-password-section button {
  margin-top: 28px;
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è */
#passwordModal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

#passwordModalContent {
  background: white;
  padding: 28px;
  border-radius: 16px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

#passwordModal h3 {
  margin-bottom: 20px;
  color: #1e293b;
}

#passwordModal input {
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  border: 1px solid #cbd5e1;
  border-radius: 10px;
}

#passwordModal .error {
  color: #ef4444;
  font-size: 14px;
  margin: 4px 0;
}

#passwordModal .success {
  color: #10b981;
  font-size: 14px;
  margin: 4px 0;
}

#passwordModal button {
  width: 100%;
  margin-top: 12px;
}
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Z ID</h1>

      <div class="tabs">
        <button class="tab active" data-tab="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <button class="tab" data-tab="login">–í—Ö–æ–¥</button>
      </div>

      <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
      <div id="tabRegister">
        <label>–ò–º—è</label>
        <input type="text" id="regName" required />

        <label>–§–∞–º–∏–ª–∏—è</label>
        <input type="text" id="regSurname" required />

        <label>–û—Ç—á–µ—Å—Ç–≤–æ</label>
        <input type="text" id="regPatronymic" required />

        <label>Z ID (10 —Ü–∏—Ñ—Ä)</label>
        <div class="input-group">
          <input type="text" id="regZID" maxlength="10" inputmode="numeric" required />
          <button class="dice-btn" id="diceBtn" title="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Z ID">üé≤</button>
        </div>
        <div id="zidError" class="error hidden"></div>

        <label>PAT</label>
        <input type="password" id="regPAT" required />

        <label>–ü–∞—Ä–æ–ª—å (8‚Äì20)</label>
        <input type="password" id="regPass" minlength="8" maxlength="20" required />
        <div id="passError" class="error hidden"></div>

        <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
        <input type="date" id="regBirth" required />

        <label>–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</label>
        <select id="regNationality" required>
          <option value="–†—É—Å—Å–∫–∏–π">–†—É—Å—Å–∫–∏–π</option>
          <option value="–£–∫—Ä–∞–∏–Ω–µ—Ü">–£–∫—Ä–∞–∏–Ω–µ—Ü</option>
          <option value="–ë–µ–ª–æ—Ä—É—Å">–ë–µ–ª–æ—Ä—É—Å</option>
          <option value="–ê–º–µ—Ä–∏–∫–∞–Ω–µ—Ü">–ê–º–µ—Ä–∏–∫–∞–Ω–µ—Ü</option>
        </select>

        <label>–ü–æ–ª</label>
        <div style="display:flex;gap:12px">
          <label><input type="radio" name="gender" value="male" required /> –ú—É–∂—Å–∫–æ–π</label>
          <label><input type="radio" name="gender" value="female" required /> –ñ–µ–Ω—Å–∫–∏–π</label>
          <label><input type="radio" name="gender" value="other" required /> –î—Ä—É–≥–æ–π</label>
        </div>

        <div id="regError" class="error hidden"></div>
        <button id="btnRegister">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      </div>

      <!-- –í—Ö–æ–¥ -->
      <div id="tabLogin" class="hidden">
        <label>Z ID</label>
        <input type="text" id="loginZID" required />

        <label>–ü–∞—Ä–æ–ª—å</label>
        <input type="password" id="loginPass" required />

        <div id="loginError" class="error hidden"></div>
        <button id="btnLogin">–í–æ–π—Ç–∏</button>
      </div>
    </div>
  </div>

  <div id="profileMenu" class="zid-profile-card">
  <div class="zid-header">
    <h2>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
  </div>

  <div class="zid-row">
    <label>–õ–∏—á–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (Z ID)</label>
    <div class="zid-highlight">
      <code id="displayZID" class="zid-code">1943228567</code>
      <button id="copyZIDBtn" class="zid-copy-btn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å Z ID">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div class="zid-notice">
      ‚ö†Ô∏è <strong>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–ø–æ–º–Ω–∏—Ç–µ –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç Z ID!</strong><br>
      –û–Ω –Ω—É–∂–µ–Ω –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –±—É–¥—É—â–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö. –ë–µ–∑ –Ω–µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.
    </div>
  </div>

  <!-- –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è -->
  <div class="zid-row">
    <label>–ò–º—è</label>
    <input type="text" id="editName" value="–ê–ª–µ–∫—Å–∞–Ω–¥—Ä" />
  </div>
  <div class="zid-row">
    <label>–§–∞–º–∏–ª–∏—è</label>
    <input type="text" id="editSurname" value="–ò–≤–∞–Ω–æ–≤" />
  </div>
  <div class="zid-row">
    <label>–û—Ç—á–µ—Å—Ç–≤–æ</label>
    <input type="text" id="editPatronymic" value="–°–µ—Ä–≥–µ–µ–≤–∏—á" />
  </div>
  <div class="zid-row">
    <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
    <input type="text" id="displayBirth" value="15.05.1990" readonly />
  </div>
  <div class="zid-row">
    <label>–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</label>
    <input type="text" id="displayNationality" value="–†—É—Å—Å–∫–∏–π" readonly />
  </div>
  <div class="zid-row">
    <label>–ü–æ–ª</label>
    <input type="text" id="displayGender" value="–ú—É–∂—Å–∫–æ–π" readonly />
  </div>

  <!-- –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è -->
  <div class="zid-row zid-password-section">
    <label>–ü–∞—Ä–æ–ª—å</label>
    <button id="changePassBtn" class="zid-btn-secondary">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
  </div>

  <!-- –≠–∫—Å–ø–æ—Ä—Ç -->
  <div class="zid-row">
    <label>–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</label>
    <button id="exportBtn" class="zid-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ JSON</button>
  </div>
</div>

  <script>
// ======= –ù–ê–ß–ê–õ–û –°–ö–†–ò–ü–¢–ê (–≤—Å—Ç–∞–≤—å—Ç–µ –ø–µ—Ä–µ–¥ </body> –∏–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π <script>) =======

// üîë Gist ID ‚Äî –∏–∑–º–µ–Ω–∏—Ç–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
const gistId = "YOUR_GIST_ID_HERE"; // ‚Üê –∑–¥–µ—Å—å –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å ID –¥–ª—è –±—É–¥—É—â–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
function loadProfile() {
  const currentZID = localStorage.getItem('currentZID');
  if (!currentZID) {
    alert('–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ.');
    window.location.href = '/'; // –∏–ª–∏ –≤–∞—à–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞
    return;
  }

  const accountJSON = localStorage.getItem(`zid_${currentZID}`);
  if (!accountJSON) {
    alert('–î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã.');
    localStorage.removeItem('currentZID');
    return;
  }

  const acc = JSON.parse(accountJSON);

  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  document.getElementById('displayZID').textContent = acc.zid;
  document.getElementById('editName').value = acc.name;
  document.getElementById('editSurname').value = acc.surname;
  document.getElementById('editPatronymic').value = acc.patronymic;
  document.getElementById('displayBirth').value = new Date(acc.birth_date).toLocaleDateString('ru-RU');
  document.getElementById('displayNationality').value = acc.nationality;
  document.getElementById('displayGender').value = acc.gender;

  // –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
  setupEventListeners(acc.zid);
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
function setupEventListeners(zid) {
  // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ Z ID
  document.getElementById('copyZIDBtn').addEventListener('click', () => {
    const zidCode = document.getElementById('displayZID').textContent;
    navigator.clipboard.writeText(zidCode).then(() => {
      const btn = document.getElementById('copyZIDBtn');
      btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
      setTimeout(() => {
        btn.textContent = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
      }, 2000);
    }).catch(err => {
      console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å:', err);
      alert('–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –í—ã–¥–µ–ª–∏—Ç–µ –∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C.');
    });
  });

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –§–ò–û
  ['editName', 'editSurname', 'editPatronymic'].forEach(id => {
    document.getElementById(id).addEventListener('blur', () => saveProfile(zid));
  });

  // –ö–Ω–æ–ø–∫–∞ "–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å"
  document.getElementById('changePassBtn').addEventListener('click', () => showPasswordModal(zid));

  // –ö–Ω–æ–ø–∫–∞ "–≠–∫—Å–ø–æ—Ä—Ç –≤ JSON"
  document.getElementById('exportBtn').addEventListener('click', () => exportProfile(zid));
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –§–ò–û (–±–µ–∑ –∑–∞–º–µ–Ω—ã Z ID, –¥–∞—Ç—ã –∏ —Ç.–¥.)
function saveProfile(zid) {
  const accountJSON = localStorage.getItem(`zid_${zid}`);
  if (!accountJSON) return;

  const acc = JSON.parse(accountJSON);
  acc.name = document.getElementById('editName').value.trim();
  acc.surname = document.getElementById('editSurname').value.trim();
  acc.patronymic = document.getElementById('editPatronymic').value.trim();

  localStorage.setItem(`zid_${zid}`, JSON.stringify(acc));
  console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω');
}

// –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON (–±–µ–∑ –ø–∞—Ä–æ–ª—è!)
function exportProfile(zid) {
  const accountJSON = localStorage.getItem(`zid_${zid}`);
  if (!accountJSON) return;

  const acc = JSON.parse(accountJSON);
  
  // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç ‚Äî –ù–ï –≤–∫–ª—é—á–∞–µ–º –ø–∞—Ä–æ–ª—å –∏ —Å–æ–ª—å!
  const safeData = {
    zid: acc.zid,
    name: acc.name,
    surname: acc.surname,
    patronymic: acc.patronymic,
    birth_date: acc.birth_date,
    nationality: acc.nationality,
    gender: acc.gender,
    created_at: acc.created_at,
    exported_at: new Date().toISOString()
  };

  const jsonStr = JSON.stringify(safeData, null, 2);
  const blob = new Blob([jsonStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `zid_${acc.zid}_backup.json`;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }, 0);
}

// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
function showPasswordModal(zid) {
  const modalHTML = `
    <div id="passwordModal">
      <div id="passwordModalContent">
        <h3>–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
        <input type="password" id="oldPass" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å" />
        <input type="password" id="newPass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (8‚Äì20)" minlength="8" maxlength="20" />
        <input type="password" id="newPass2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" />
        <div id="passError" class="error"></div>
        <div id="passSuccess" class="success"></div>
        <button id="savePassBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="cancelPassBtn" style="background:#e2e8f0;color:#475569;margin-top:8px">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  document.getElementById('cancelPassBtn').onclick = () => {
    document.getElementById('passwordModal').remove();
  };
  
  document.getElementById('savePassBtn').onclick = async () => {
    const oldPass = document.getElementById('oldPass').value;
    const newPass = document.getElementById('newPass').value;
    const newPass2 = document.getElementById('newPass2').value;
    const errEl = document.getElementById('passError');
    const okEl = document.getElementById('passSuccess');

    errEl.textContent = '';
    okEl.textContent = '';

    if (newPass !== newPass2) {
      errEl.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
      return;
    }

    if (newPass.length < 8 || newPass.length > 20) {
      errEl.textContent = '–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 8‚Äì20 —Å–∏–º–≤–æ–ª–æ–≤';
      return;
    }

    // –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Web Crypto API)
    const account = JSON.parse(localStorage.getItem(`zid_${zid}`));
    const encoder = new TextEncoder();
    const oldHash = await crypto.subtle.importKey(
      'raw', encoder.encode(oldPass), { name: 'PBKDF2' }, false, ['deriveBits']
    ).then(key =>
      crypto.subtle.deriveBits(
        { name: 'PBKDF2', salt: encoder.encode(account.salt), iterations: 100000, hash: 'SHA-256' },
        key, 256
      )
    ).then(bits => {
      const arr = Array.from(new Uint8Array(bits));
      return arr.map(b => b.toString(16).padStart(2, '0')).join('');
    }).catch(() => null);

    if (oldHash !== account.password_hash) {
      errEl.textContent = '–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–µ–Ω';
      return;
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —Ö—ç—à–∞
    const newSalt = Array.from(crypto.getRandomValues(new Uint8Array(32)), b => b.toString(16).padStart(2, '0')).join('');
    const newHash = await crypto.subtle.importKey(
      'raw', encoder.encode(newPass), { name: 'PBKDF2' }, false, ['deriveBits']
    ).then(key =>
      crypto.subtle.deriveBits(
        { name: 'PBKDF2', salt: encoder.encode(newSalt), iterations: 100000, hash: 'SHA-256' },
        key, 256
      )
    ).then(bits => {
      const arr = Array.from(new Uint8Array(bits));
      return arr.map(b => b.toString(16).padStart(2, '0')).join('');
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    account.password_hash = newHash;
    account.salt = newSalt;
    localStorage.setItem(`zid_${zid}`, JSON.stringify(account));

    okEl.textContent = '‚úÖ –ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω';
    setTimeout(() => {
      document.getElementById('passwordModal').remove();
    }, 1500);
  };
}

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', loadProfile);
</script>
</body>
</html>

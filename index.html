<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Z ID ‚Äî –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --border: #e2e8f0;
      --primary: #6366f1;
      --dice: #94a3b8;
      --dice-hover: #64748b;
      --success: #10b981;
      --error: #ef4444;
    }
    [data-theme="dark"] {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f1f5f9;
      --border: #334155;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      padding: 20px;
      min-height: 100vh;
      transition: background-color 0.3s;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
      margin-bottom: 24px;
      border: 1px solid var(--border);
    }

    h1, h2 {
      font-weight: 800;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 28px;
      text-align: center;
      color: var(--primary);
    }

    label {
      display: block;
      margin: 16px 0 8px;
      font-weight: 600;
    }

    .input-group {
      position: relative;
    }

    input, select, button {
      width: 100%;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      color: var(--text);
      font-size: 16px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    /* –ö–Ω–æ–ø–∫–∞-–∫–æ—Å—Ç—å üé≤ */
    .dice-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      background: var(--dice);
      color: white;
      border: none;
      border-radius: 50%;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .dice-btn:hover {
      background: var(--dice-hover);
    }

    .dice-btn:active {
      transform: translateY(-50%) scale(0.95);
    }

    .error {
      color: var(--error);
      font-size: 14px;
      margin-top: -12px;
      margin-bottom: 12px;
    }

    .success {
      color: var(--success);
      font-size: 14px;
      margin-top: -12px;
      margin-bottom: 12px;
    }

    button {
      background: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      border: none;
      margin-top: 16px;
      transition: opacity 0.2s;
    }

    button:hover {
      opacity: 0.9;
    }

    .hidden {
      display: none;
    }

    .profile-info {
      line-height: 1.6;
    }

    .profile-info p {
      margin: 8px 0;
    }

    .profile-info strong {
      margin-right: 8px;
      color: var(--primary);
    }

    .notice {
      background: rgba(99, 102, 241, 0.1);
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      margin-top: 16px;
    }

    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      font-weight: 500;
    }

    .tab.active {
      background: var(--primary);
      color: white;
    }

    .accounts-badge {
      background: var(--primary);
      color: white;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 6px;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      font-size: 14px;
      color: #64748b;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –∫–æ—Å—Ç–∏ */
    @keyframes spin {
      0% { transform: translateY(-50%) rotate(0deg); }
      100% { transform: translateY(-50%) rotate(360deg); }
    }
    .dice-spin {
      animation: spin 0.5s ease-out;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Auth Screens -->
    <div id="authScreen" class="card">
      <h1>Z ID</h1>
      <p style="text-align:center; margin-bottom:24px; color:#64748b">
        –£–Ω–∏–∫–∞–ª—å–Ω—ã–π 10-–∑–Ω–∞—á–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –≤—Å–µ—Ö –≤–∞—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
      </p>

      <!-- Switcher -->
      <div class="tabs">
        <button class="tab active" data-view="login">–í—Ö–æ–¥</button>
        <button class="tab" data-view="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>

      <!-- Login Form -->
      <div id="loginView">
        <label for="loginZID">Z ID (10 —Ü–∏—Ñ—Ä)</label>
        <input type="text" id="loginZID" placeholder="1943228567" maxlength="10" inputmode="numeric" />

        <label for="loginPass">–ü–∞—Ä–æ–ª—å</label>
        <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

        <div id="loginError" class="error hidden"></div>
        <button id="btnLogin">–í–æ–π—Ç–∏</button>
      </div>

      <!-- Registration Form -->
      <div id="registerView" class="hidden">
        <label for="regName">–ò–º—è</label>
        <input type="text" id="regName" placeholder="–ê–ª–µ–∫—Å–∞–Ω–¥—Ä" required />

        <label for="regSurname">–§–∞–º–∏–ª–∏—è</label>
        <input type="text" id="regSurname" placeholder="–ò–≤–∞–Ω–æ–≤" required />

        <label for="regPatronymic">–û—Ç—á–µ—Å—Ç–≤–æ</label>
        <input type="text" id="regPatronymic" placeholder="–°–µ—Ä–≥–µ–µ–≤–∏—á" required />

        <label for="regZID">Z ID (10 —Ü–∏—Ñ—Ä)</label>
        <div class="input-group">
          <input type="text" id="regZID" placeholder="1943228567" maxlength="10" inputmode="numeric" required />
          <button class="dice-btn" id="diceBtn" title="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–π Z ID">üé≤</button>
        </div>
        <div class="notice">
          üî¢ –¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã. –ö–∞–∂–¥–∞—è ‚Äî –Ω–µ –±–æ–ª–µ–µ 3 —Ä–∞–∑.  
          <br>‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è: –Ω–∏–∫—Ç–æ –Ω–µ –ø–æ–ª—É—á–∏—Ç –≤–∞—à Z ID.
        </div>
        <div id="zidError" class="error hidden"></div>

        <label for="regPass">–ü–∞—Ä–æ–ª—å (8‚Äì20 —Å–∏–º–≤–æ–ª–æ–≤)</label>
        <input type="password" id="regPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8" maxlength="20" required />
        <div id="passError" class="error hidden"></div>

        <label for="regBirth">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
        <input type="date" id="regBirth" required />

        <label for="regNationality">–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</label>
        <select id="regNationality" required></select>

        <label>–ü–æ–ª</label>
        <div style="display:flex;gap:16px;margin-bottom:16px">
          <label><input type="radio" name="gender" value="male" required /> –ú—É–∂—Å–∫–æ–π</label>
          <label><input type="radio" name="gender" value="female" /> –ñ–µ–Ω—Å–∫–∏–π</label>
          <label><input type="radio" name="gender" value="other" /> –î—Ä—É–≥–æ–π</label>
        </div>

        <div id="regError" class="error hidden"></div>
        <button id="btnRegister">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      </div>
    </div>

    <!-- Profile Screen -->
    <div id="profileScreen" class="card hidden">
      <div class="tabs">
        <button class="tab active" data-tab="info">–ü—Ä–æ—Ñ–∏–ª—å</button>
        <button class="tab" data-tab="password">–ü–∞—Ä–æ–ª—å</button>
        <button class="tab" data-tab="export">–≠–∫—Å–ø–æ—Ä—Ç</button>
        <button class="tab" data-tab="logout">–í—ã—Ö–æ–¥</button>
      </div>

      <div id="tabInfo">
        <h2>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h2>
        <div class="profile-info">
          <p><strong>Z ID:</strong> <span id="pZID"></span></p>
          <p><strong>–ò–º—è:</strong> <span id="pName"></span></p>
          <p><strong>–§–∞–º–∏–ª–∏—è:</strong> <span id="pSurname"></span></p>
          <p><strong>–û—Ç—á–µ—Å—Ç–≤–æ:</strong> <span id="pPatronymic"></span></p>
          <p><strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> <span id="pBirth"></span></p>
          <p><strong>–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:</strong> <span id="pNationality"></span></p>
          <p><strong>–ü–æ–ª:</strong> <span id="pGender"></span></p>
        </div>
        <div class="notice">
          üí° –≠—Ç–æ—Ç Z ID —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ <code>localStorage</code>.  
          –í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤ –ª—é–±—ã—Ö –±—É–¥—É—â–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö.
        </div>
        <br>
        <button onclick="showAccounts()">–ú–æ–∏ –∞–∫–∫–∞—É–Ω—Ç—ã <span class="accounts-badge" id="accountsCount">0</span></button>
      </div>

      <div id="tabPassword" class="hidden">
        <h2>–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h2>
        <label for="oldPass">–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å</label>
        <input type="password" id="oldPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

        <label for="newPass">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (8‚Äì20 —Å–∏–º–≤–æ–ª–æ–≤)</label>
        <input type="password" id="newPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8" maxlength="20" />

        <label for="newPass2">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
        <input type="password" id="newPass2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

        <div id="passChangeError" class="error hidden"></div>
        <div id="passChangeSuccess" class="success hidden"></div>
        <button id="btnChangePass">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>

      <div id="tabExport" class="hidden">
        <h2>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
        <p>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç JSON ‚Äî –æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å.</p>
        <div class="notice">üìÅ –í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.</div>
        <textarea id="exportArea" rows="8" readonly style="font-family:monospace; font-size:14px"></textarea>
        <button onclick="copyExport()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON</button>
        <div id="copyStatus" class="success" style="display:none">‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</div>
      </div>

      <div id="tabLogout" class="hidden">
        <h2>–í—ã—Ö–æ–¥</h2>
        <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
        <button id="btnConfirmLogout" style="background:var(--error)">–í—ã–π—Ç–∏</button>
      </div>

      <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ -->
      <div id="accountsModal" class="hidden">
        <h2>–ú–æ–∏ –∞–∫–∫–∞—É–Ω—Ç—ã</h2>
        <div id="accountsList"></div>
        <button onclick="closeAccountsModal()" style="margin-top:16px">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <footer>
    &copy; 2025 Z ID System ‚Ä¢ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ<br>
    GitHub Pages Edition ‚Äî 100% –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π, –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞
  </footer>

  <script>
    // === –î–ê–ù–ù–´–ï ===
    const NATIONALITIES = [
      "–†—É—Å—Å–∫–∏–π", "–£–∫—Ä–∞–∏–Ω–µ—Ü", "–ë–µ–ª–æ—Ä—É—Å", "–¢–∞—Ç–∞—Ä–∏–Ω", "–ß–µ—á–µ–Ω–µ—Ü", "–ê—Ä–º—è–Ω–∏–Ω", "–ì—Ä—É–∑–∏–Ω", "–ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω–µ—Ü", "–ö–∞–∑–∞—Ö", "–£–∑–±–µ–∫",
      "–ù–µ–º–µ—Ü", "–§—Ä–∞–Ω—Ü—É–∑", "–ò—Ç–∞–ª—å—è–Ω–µ—Ü", "–ò—Å–ø–∞–Ω–µ—Ü", "–ê–Ω–≥–ª–∏—á–∞–Ω–∏–Ω", "–ü–æ–ª—è–∫", "–ß–µ—Ö", "–í–µ–Ω–≥—Ä", "–Ø–ø–æ–Ω–µ—Ü", "–ê–º–µ—Ä–∏–∫–∞–Ω–µ—Ü"
    ];

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    document.addEventListener('DOMContentLoaded', () => {
      initNationalities();
      bindEvents();
      updateAccountsCount();

      // –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ —Ç–µ–∫—É—â–∏–π –∞–∫–∫–∞—É–Ω—Ç?
      const currentZID = localStorage.getItem('currentZID');
      if (currentZID && localStorage.getItem(`zid_${currentZID}`)) {
        showProfile(currentZID);
      }
    });

    function initNationalities() {
      const select = document.getElementById('regNationality');
      NATIONALITIES.forEach(nat => {
        const opt = document.createElement('option');
        opt.value = nat;
        opt.textContent = nat;
        select.appendChild(opt);
      });
      select.value = '–†—É—Å—Å–∫–∏–π';
    }

    function bindEvents() {
      // –í–∫–ª–∞–¥–∫–∏
      document.querySelectorAll('.tab[data-view]').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab[data-view]').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          document.querySelectorAll('[id$="View"]').forEach(el => el.classList.add('hidden'));
          document.getElementById(tab.dataset.view + 'View').classList.remove('hidden');
        });
      });

      // –ö–Ω–æ–ø–∫–∏
      document.getElementById('btnLogin').addEventListener('click', handleLogin);
      document.getElementById('btnRegister').addEventListener('click', handleRegister);
      document.getElementById('btnChangePass').addEventListener('click', handleChangePassword);
      document.getElementById('btnConfirmLogout').addEventListener('click', handleLogout);

      // –ö–æ—Å—Ç—å üé≤
      document.getElementById('diceBtn').addEventListener('click', generateFreeZID);

      // –í–∫–ª–∞–¥–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
      document.querySelectorAll('.tab[data-tab]').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab[data-tab]').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          document.querySelectorAll('[id^="tab"]').forEach(el => el.classList.add('hidden'));
          document.getElementById(`tab${tab.dataset.tab.charAt(0).toUpperCase() + tab.dataset.tab.slice(1)}`).classList.remove('hidden');
          if (tab.dataset.tab === 'export') {
            generateExport();
          }
        });
      });

      // Z ID –≤–≤–æ–¥
      document.getElementById('regZID').addEventListener('input', validateZIDInput);
      document.getElementById('regPass').addEventListener('input', validatePasswordInput);
    }

    // === –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–í–û–ë–û–î–ù–û–ì–û Z ID (—Å —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å—é!) ===
    function generateZID() {
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç Z ID –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º: 10 —Ü–∏—Ñ—Ä, –∫–∞–∂–¥–∞—è ‚â§3 —Ä–∞–∑
      let zid;
      do {
        zid = '';
        const counts = {};
        for (let i = 0; i < 10; i++) {
          let d;
          do {
            d = Math.floor(Math.random() * 10).toString();
          } while (counts[d] >= 3);
          zid += d;
          counts[d] = (counts[d] || 0) + 1;
        }
      } while (zid.length !== 10);
      return zid;
    }

    function isZIDFree(zid) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ —É–∂–µ –≤ localStorage?
      for (let key in localStorage) {
        if (key.startsWith('zid_') && key !== 'currentZID') {
          try {
            const acc = JSON.parse(localStorage.getItem(key));
            if (acc.zid === zid) return false;
          } catch (e) {}
        }
      }
      return true;
    }

    async function generateFreeZID() {
      const btn = document.getElementById('diceBtn');
      btn.classList.add('dice-spin');
      btn.disabled = true;

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º, –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥—ë–º —Å–≤–æ–±–æ–¥–Ω—ã–π
      let attempts = 0;
      let zid;
      do {
        zid = generateZID();
        attempts++;
        if (attempts > 1000) break; // –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è
      } while (!isZIDFree(zid));

      document.getElementById('regZID').value = zid;
      validateZIDInput();

      setTimeout(() => {
        btn.classList.remove('dice-spin');
        btn.disabled = false;
      }, 500);
    }

    // === –í–ê–õ–ò–î–ê–¶–ò–Ø ===
    function validateZID(zid) {
      if (zid.length !== 10 || !/^\d{10}$/.test(zid)) {
        return { valid: false, message: 'Z ID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–æ–≤–Ω–æ 10 —Ü–∏—Ñ—Ä' };
      }
      const counts = {};
      for (let d of zid) {
        counts[d] = (counts[d] || 0) + 1;
        if (counts[d] > 3) {
          return { valid: false, message: '–¶–∏—Ñ—Ä–∞ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è –±–æ–ª–µ–µ 3 —Ä–∞–∑' };
        }
      }
      return { valid: true };
    }

    function validateZIDInput() {
      const input = document.getElementById('regZID');
      const zid = input.value.replace(/\D/g, '');
      input.value = zid;
      const err = document.getElementById('zidError');
      const res = validateZID(zid);
      if (!res.valid) {
        err.textContent = res.message;
        err.classList.remove('hidden');
      } else {
        err.classList.add('hidden');
      }
    }

    function validatePasswordInput() {
      const pass = document.getElementById('regPass').value;
      const err = document.getElementById('passError');
      if (pass.length < 8 || pass.length > 20) {
        err.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 8‚Äì20 —Å–∏–º–≤–æ–ª–æ–≤';
        err.classList.remove('hidden');
      } else {
        err.classList.add('hidden');
      }
    }

    // === –•–≠–®–ò–†–û–í–ê–ù–ò–ï (PBKDF2 —á–µ—Ä–µ–∑ Web Crypto) ===
    async function hashPassword(password, salt = null) {
      if (!salt) {
        const arr = new Uint8Array(32);
        crypto.getRandomValues(arr);
        salt = Array.from(arr, b => b.toString(16).padStart(2, '0')).join('');
      }

      const enc = new TextEncoder();
      const key = await crypto.subtle.importKey(
        'raw', enc.encode(password), { name: 'PBKDF2' }, false, ['deriveBits']
      );

      const bits = await crypto.subtle.deriveBits({
        name: 'PBKDF2',
        salt: enc.encode(salt),
        iterations: 100000,
        hash: 'SHA-256'
      }, key, 256);

      const hashArr = Array.from(new Uint8Array(bits));
      const hashHex = hashArr.map(b => b.toString(16).padStart(2, '0')).join('');
      return { hash: hashHex, salt };
    }

    // === –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ===
    async function handleRegister() {
      const name = document.getElementById('regName').value.trim();
      const surname = document.getElementById('regSurname').value.trim();
      const patronymic = document.getElementById('regPatronymic').value.trim();
      const zid = document.getElementById('regZID').value.trim();
      const pass = document.getElementById('regPass').value;
      const birth = document.getElementById('regBirth').value;
      const nationality = document.getElementById('regNationality').value;
      const genderEl = document.querySelector('input[name="gender"]:checked');
      const gender = genderEl ? genderEl.value : '';

      if (!name || !surname || !patronymic || !zid || !pass || !birth || !nationality || !gender) {
        showError('regError', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
      }

      const zidCheck = validateZID(zid);
      if (!zidCheck.valid) {
        showError('zidError', zidCheck.message);
        return;
      }

      if (pass.length < 8 || pass.length > 20) {
        showError('passError', '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 8‚Äì20 —Å–∏–º–≤–æ–ª–æ–≤');
        return;
      }

      // üîí –ì–ê–†–ê–ù–¢–ò–Ø –£–ù–ò–ö–ê–õ–¨–ù–û–°–¢–ò: –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
      if (!isZIDFree(zid)) {
        showError('zidError', '–≠—Ç–æ—Ç Z ID —É–∂–µ –∑–∞–Ω—è—Ç. –ù–∞–∂–º–∏—Ç–µ üé≤ –¥–ª—è –Ω–æ–≤–æ–≥–æ.');
        return;
      }

      // –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
      const { hash, salt } = await hashPassword(pass);

      const account = {
        zid,
        name,
        surname,
        patronymic,
        password_hash: hash,
        salt,
        birth_date: birth,
        nationality,
        gender: ({male: '–ú—É–∂—Å–∫–æ–π', female: '–ñ–µ–Ω—Å–∫–∏–π', other: '–î—Ä—É–≥–æ–π'})[gender],
        created_at: new Date().toISOString()
      };

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
      localStorage.setItem(`zid_${zid}`, JSON.stringify(account));
      localStorage.setItem('currentZID', zid);

      showProfile(zid);
    }

    // === –í–•–û–î ===
    async function handleLogin() {
      const zid = document.getElementById('loginZID').value.trim();
      const pass = document.getElementById('loginPass').value;

      if (!zid || !pass) {
        showError('loginError', '–í–≤–µ–¥–∏—Ç–µ Z ID –∏ –ø–∞—Ä–æ–ª—å');
        return;
      }

      const accountJSON = localStorage.getItem(`zid_${zid}`);
      if (!accountJSON) {
        showError('loginError', '–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
      }

      const account = JSON.parse(accountJSON);
      const { hash } = await hashPassword(pass, account.salt);

      if (hash !== account.password_hash) {
        showError('loginError', '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
        return;
      }

      localStorage.setItem('currentZID', zid);
      showProfile(zid);
    }

    // === –ü–†–û–§–ò–õ–¨ ===
    function showProfile(zid) {
      const accountJSON = localStorage.getItem(`zid_${zid}`);
      if (!accountJSON) {
        localStorage.removeItem('currentZID');
        renderView('login');
        return;
      }

      const acc = JSON.parse(accountJSON);
      document.getElementById('pZID').textContent = acc.zid;
      document.getElementById('pName').textContent = acc.name;
      document.getElementById('pSurname').textContent = acc.surname;
      document.getElementById('pPatronymic').textContent = acc.patronymic;
      document.getElementById('pBirth').textContent = new Date(acc.birth_date).toLocaleDateString('ru-RU');
      document.getElementById('pNationality').textContent = acc.nationality;
      document.getElementById('pGender').textContent = acc.gender;

      document.getElementById('authScreen').classList.add('hidden');
      document.getElementById('profileScreen').classList.remove('hidden');
      updateAccountsCount();
    }

    // === –°–ú–ï–ù–ê –ü–ê–†–û–õ–Ø ===
    async function handleChangePassword() {
      const zid = localStorage.getItem('currentZID');
      const account = JSON.parse(localStorage.getItem(`zid_${zid}`));

      const oldPass = document.getElementById('oldPass').value;
      const newPass = document.getElementById('newPass').value;
      const newPass2 = document.getElementById('newPass2').value;
      const errEl = document.getElementById('passChangeError');
      const okEl = document.getElementById('passChangeSuccess');

      if (newPass !== newPass2) {
        showErrorEl(errEl, '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
        return;
      }

      if (newPass.length < 8 || newPass.length > 20) {
        showErrorEl(errEl, '–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 8‚Äì20 —Å–∏–º–≤–æ–ª–æ–≤');
        return;
      }

      const { hash } = await hashPassword(oldPass, account.salt);
      if (hash !== account.password_hash) {
        showErrorEl(errEl, '–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–µ–Ω');
        return;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º
      const { hash: newHash, salt: newSalt } = await hashPassword(newPass);
      account.password_hash = newHash;
      account.salt = newSalt;
      localStorage.setItem(`zid_${zid}`, JSON.stringify(account));

      showSuccessEl(okEl, '‚úÖ –ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω');
      setTimeout(() => okEl.classList.add('hidden'), 2000);
    }

    // === –≠–ö–°–ü–û–†–¢ ===
    function generateExport() {
      const zid = localStorage.getItem('currentZID');
      const account = JSON.parse(localStorage.getItem(`zid_${zid}`));
      if (!account) return;

      const data = {
        zid: account.zid,
        name: account.name,
        surname: account.surname,
        patronymic: account.patronymic,
        birth_date: account.birth_date,
        nationality: account.nationality,
        gender: account.gender,
        created_at: account.created_at
        // ‚ùó –ø–∞—Ä–æ–ª—å –ù–ï —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å!
      };

      document.getElementById('exportArea').value = JSON.stringify(data, null, 2);
    }

    function copyExport() {
      const textarea = document.getElementById('exportArea');
      textarea.select();
      document.execCommand('copy');
      const status = document.getElementById('copyStatus');
      status.style.display = 'block';
      setTimeout(() => status.style.display = 'none', 2000);
    }

    // === –£–¢–ò–õ–ò–¢–´ ===
    function showError(id, msg) {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.classList.remove('hidden');
      el.classList.add('error');
    }

    function showErrorEl(el, msg) {
      el.textContent = msg;
      el.classList.remove('hidden');
      el.classList.add('error');
    }

    function showSuccessEl(el, msg) {
      el.textContent = msg;
      el.classList.remove('hidden');
      el.classList.remove('error');
      el.classList.add('success');
    }

    function renderView(view) {
      document.querySelectorAll('.tab[data-view]').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[data-view="${view}"]`)?.classList.add('active');
      document.querySelectorAll('[id$="View"]').forEach(el => el.classList.add('hidden'));
      document.getElementById(view + 'View')?.classList.remove('hidden');
    }

    function handleLogout() {
      localStorage.removeItem('currentZID');
      renderView('login');
      document.getElementById('profileScreen').classList.add('hidden');
      document.getElementById('authScreen').classList.remove('hidden');
    }

    // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –ê–ö–ö–ê–£–ù–¢–ê–ú–ò ===
    function updateAccountsCount() {
      let count = 0;
      for (let key in localStorage) {
        if (key.startsWith('zid_') && key !== 'currentZID') count++;
      }
      document.getElementById('accountsCount').textContent = count;
    }

    function showAccounts() {
      let html = '<ul style="list-style:none; padding:0">';
      let count = 0;
      for (let key in localStorage) {
        if (key.startsWith('zid_') && key !== 'currentZID') {
          try {
            const acc = JSON.parse(localStorage.getItem(key));
            html += `<li style="margin:12px 0; padding-bottom:12px; border-bottom:1px solid var(--border);">
              <strong>${acc.zid}</strong><br>
              ${acc.name} ${acc.surname}<br>
              <button onclick="switchTo('${acc.zid}')" style="margin-top:6px; padding:6px 12px">–í–æ–π—Ç–∏</button>
              <button onclick="deleteAccount('${acc.zid}')" style="margin-left:8px; padding:6px 12px; background:var(--error)">–£–¥–∞–ª–∏—Ç—å</button>
            </li>`;
            count++;
          } catch (e) {}
        }
      }
      if (count === 0) {
        html += '<li>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</li>';
      }
      html += '</ul>';

      document.getElementById('accountsList').innerHTML = html;
      document.getElementById('accountsModal').classList.remove('hidden');
    }

    function closeAccountsModal() {
      document.getElementById('accountsModal').classList.add('hidden');
    }

    function switchTo(zid) {
      localStorage.setItem('currentZID', zid);
      closeAccountsModal();
      showProfile(zid);
    }

    function deleteAccount(zid) {
      if (confirm(`–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç ${zid}? –≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
        localStorage.removeItem(`zid_${zid}`);
        if (localStorage.getItem('currentZID') === zid) {
          localStorage.removeItem('currentZID');
        }
        showAccounts();
        updateAccountsCount();
      }
    }
  </script>
</body>
</html>

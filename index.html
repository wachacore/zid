<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Z ID ‚Äî –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --border: #e2e8f0;
      --primary: #4f46e5;
      --dice: #94a3b8;
      --success: #10b981;
      --error: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 520px;
      margin: 0 auto;
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      margin-bottom: 24px;
      border: 1px solid var(--border);
    }

    h1, h2 {
      font-weight: 700;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 28px;
      text-align: center;
      color: var(--primary);
    }

    label {
      display: block;
      margin: 16px 0 8px;
      font-weight: 600;
    }

    .input-group {
      position: relative;
    }

    input, select, button {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--card);
      color: var(--text);
      font-size: 16px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    .dice-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      background: var(--dice);
      color: white;
      border: none;
      border-radius: 50%;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dice-btn:hover {
      background: #64748b;
    }

    .error {
      color: var(--error);
      font-size: 14px;
      margin-top: -12px;
      margin-bottom: 12px;
    }

    .success {
      color: var(--success);
      font-size: 14px;
      margin-top: -12px;
      margin-bottom: 12px;
    }

    button {
      background: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      border: none;
      margin-top: 16px;
      transition: opacity 0.2s;
    }

    button:hover {
      opacity: 0.9;
    }

    button.secondary {
      background: #e2e8f0;
      color: #475569;
    }

    .hidden {
      display: none;
    }

    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      font-weight: 500;
    }

    .tab.active {
      background: var(--primary);
      color: white;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      font-size: 14px;
      color: #64748b;
    }

    /* –ú–µ–Ω—é –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ */
    .zid-profile-card {
      max-width: 520px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 28px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: #1e293b;
      border: 1px solid #e2e8f0;
    }

    .zid-header h2 {
      font-weight: 700;
      font-size: 24px;
      margin-bottom: 24px;
      color: #4f46e5;
      text-align: center;
    }

    .zid-row {
      margin-bottom: 20px;
    }

    .zid-row input[readonly] {
      background: #f1f5f9;
      cursor: not-allowed;
    }

    .zid-highlight {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .zid-code {
      padding: 10px 16px;
      background: #0f172a;
      color: #60a5fa;
      font-family: 'SF Mono', 'Consolas', monospace;
      font-size: 20px;
      font-weight: 600;
      border-radius: 8px;
      letter-spacing: 2px;
      min-width: 200px;
      text-align: center;
      box-shadow: 0 0 0 2px #3b82f6;
    }

    .zid-copy-btn {
      padding: 10px 16px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .zid-copy-btn:hover {
      background: #2563eb;
    }

    .zid-notice {
      background: #fffbeb;
      border: 1px solid #f59e0b;
      color: #92400e;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      margin-top: 8px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.2); }
      50% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
    }

    /* –ü–∞—Ä–æ–ª—å ‚Äî —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞, –ø–æ—Ç–æ–º –ø–æ–ª–µ */
    #changePassSection {
      position: relative;
    }

    #changePassSection label {
      position: absolute;
      top: 0;
      left: 0;
    }

    #changePassSection button {
      margin-top: 28px;
    }

    .password-inputs {
      margin-top: 16px;
    }

    .password-inputs input {
      margin-top: 8px;
    }

    /* –≠–∫—Å–ø–æ—Ä—Ç */
    #exportSection {
      margin-top: 24px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div id="authScreen" class="card">
      <h1>Z ID</h1>

      <div class="tabs">
        <button class="tab active" data-view="login">–í—Ö–æ–¥</button>
        <button class="tab" data-view="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>

      <!-- –í—Ö–æ–¥ -->
      <div id="loginView">
        <label for="loginZID">Z ID (10 —Ü–∏—Ñ—Ä)</label>
        <input type="text" id="loginZID" placeholder="1943228567" maxlength="10" inputmode="numeric" />

        <label for="loginPass">–ü–∞—Ä–æ–ª—å</label>
        <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

        <div id="loginError" class="error hidden"></div>
        <button id="btnLogin">–í–æ–π—Ç–∏</button>
      </div>

      <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
      <div id="registerView" class="hidden">
        <label for="regName">–ò–º—è</label>
        <input type="text" id="regName" placeholder="–ê–ª–µ–∫—Å–∞–Ω–¥—Ä" required />

        <label for="regSurname">–§–∞–º–∏–ª–∏—è</label>
        <input type="text" id="regSurname" placeholder="–ò–≤–∞–Ω–æ–≤" required />

        <label for="regPatronymic">–û—Ç—á–µ—Å—Ç–≤–æ</label>
        <input type="text" id="regPatronymic" placeholder="–°–µ—Ä–≥–µ–µ–≤–∏—á" required />

        <label for="regZID">Z ID (10 —Ü–∏—Ñ—Ä)</label>
        <div class="input-group">
          <input type="text" id="regZID" placeholder="1943228567" maxlength="10" inputmode="numeric" required />
          <button class="dice-btn" id="diceBtn">üé≤</button>
        </div>
        <div class="error hidden" id="zidError"></div>

        <label for="regPass">–ü–∞—Ä–æ–ª—å (8‚Äì20)</label>
        <input type="password" id="regPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8" maxlength="20" required />
        <div class="error hidden" id="passError"></div>

        <label for="regBirth">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
        <input type="date" id="regBirth" required />

        <label for="regNationality">–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</label>
        <select id="regNationality">
          <option value="–†—É—Å—Å–∫–∏–π">–†—É—Å—Å–∫–∏–π</option>
          <option value="–£–∫—Ä–∞–∏–Ω–µ—Ü">–£–∫—Ä–∞–∏–Ω–µ—Ü</option>
          <option value="–ë–µ–ª–æ—Ä—É—Å">–ë–µ–ª–æ—Ä—É—Å</option>
          <option value="–¢–∞—Ç–∞—Ä–∏–Ω">–¢–∞—Ç–∞—Ä–∏–Ω</option>
          <option value="–ß–µ—á–µ–Ω–µ—Ü">–ß–µ—á–µ–Ω–µ—Ü</option>
          <option value="–ê—Ä–º—è–Ω–∏–Ω">–ê—Ä–º—è–Ω–∏–Ω</option>
        </select>

        <label>–ü–æ–ª</label>
        <div style="display:flex;gap:16px;margin-bottom:16px">
          <label><input type="radio" name="gender" value="male" required /> –ú—É–∂—Å–∫–æ–π</label>
          <label><input type="radio" name="gender" value="female" /> –ñ–µ–Ω—Å–∫–∏–π</label>
          <label><input type="radio" name="gender" value="other" /> –î—Ä—É–≥–æ–π</label>
        </div>

        <!-- üîë –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π PAT -->
        <label for="regPat">GitHub PAT (–¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Gist)</label>
        <input type="password" id="regPat" placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required />
        <div class="notice">
          üîë –°–æ–∑–¥–∞–π—Ç–µ —Ç–æ–∫–µ–Ω —Å –ø—Ä–∞–≤–æ–º <code>gist</code> –≤ GitHub ‚Üí Settings ‚Üí Developer settings
        </div>
        <div class="error hidden" id="patError"></div>

        <div id="regError" class="error hidden"></div>
        <button id="btnRegister">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      </div>
    </div>

    <!-- –ú–µ–Ω—é –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ -->
    <div id="profileMenu" class="zid-profile-card hidden">
      <div class="zid-header">
        <h2>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
      </div>

      <div class="zid-row">
        <label>–õ–∏—á–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (Z ID)</label>
        <div class="zid-highlight">
          <code id="displayZID" class="zid-code">1943228567</code>
          <button id="copyZIDBtn" class="zid-copy-btn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div class="zid-notice">
          ‚ö†Ô∏è <strong>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–ø–æ–º–Ω–∏—Ç–µ –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç Z ID!</strong><br>
          –û–Ω –Ω—É–∂–µ–Ω –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –±—É–¥—É—â–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö. –ë–µ–∑ –Ω–µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.
        </div>
      </div>

      <div class="zid-row">
        <label>–ò–º—è</label>
        <input type="text" id="displayName" value="–ê–ª–µ–∫—Å–∞–Ω–¥—Ä" readonly />
      </div>
      <div class="zid-row">
        <label>–§–∞–º–∏–ª–∏—è</label>
        <input type="text" id="displaySurname" value="–ò–≤–∞–Ω–æ–≤" readonly />
      </div>
      <div class="zid-row">
        <label>–û—Ç—á–µ—Å—Ç–≤–æ</label>
        <input type="text" id="displayPatronymic" value="–°–µ—Ä–≥–µ–µ–≤–∏—á" readonly />
      </div>
      <div class="zid-row">
        <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
        <input type="text" id="displayBirth" value="15.05.1990" readonly />
      </div>
      <div class="zid-row">
        <label>–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</label>
        <input type="text" id="displayNationality" value="–†—É—Å—Å–∫–∏–π" readonly />
      </div>
      <div class="zid-row">
        <label>–ü–æ–ª</label>
        <input type="text" id="displayGender" value="–ú—É–∂—Å–∫–æ–π" readonly />
      </div>

      <!-- –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è: –∫–Ω–æ–ø–∫–∞ ‚Üí –ø–æ–ª–µ -->
      <div id="changePassSection" class="zid-row">
        <label>–ü–∞—Ä–æ–ª—å</label>
        <button id="changePassBtn" class="secondary">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
        <div id="passwordInputs" class="password-inputs hidden">
          <input type="password" id="newPass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (8‚Äì20)" minlength="8" maxlength="20" />
          <input type="password" id="newPass2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" />
          <div id="passResult" class="error hidden"></div>
          <button id="savePassBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>

      <!-- –≠–∫—Å–ø–æ—Ä—Ç -->
      <div id="exportSection">
        <button id="exportBtn" class="zid-btn">üì• –°–∫–∞—á–∞—Ç—å reservedZID.json</button>
      </div>
    </div>
  </div>

  <footer>
    &copy; 2025 Z ID System ‚Ä¢ –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –≤–∞—à–µ–º GitHub Gist
  </footer>

  <script>
  // üîë Gist ID ‚Äî —É–∂–µ –≤–∞—à
  const gistId = "ec5454500e71d26ef32bab5a0febb8aada"; // ‚Üê –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —É–±—Ä–∞–ª –ª–∏—à–Ω—é—é —Ü–∏—Ñ—Ä—É (–±—ã–ª–æ 33 –∑–Ω–∞–∫–∞, –∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 32)

  // === –ù–ê–î–ï–ñ–ù–´–ô –ü–†–û–ö–°–ò ===
  function proxy(method, url, headers = {}, body = null) {
    const proxyUrl = 'https://api.codetabs.com/v1/proxy';
    const data = {
      method: method.toUpperCase(),
      url: url,
      headers: headers,
      body: body ? JSON.stringify(body) : undefined
    };
    return fetch(proxyUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
  }

  async function readGist(pat) {
    const res = await proxy('GET', `https://api.github.com/gists/${gistId}`, {
      'Authorization': 'token ' + pat,
      'User-Agent': 'Z-ID-App'
    });
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`Gist –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω (${res.status}): ${text.substring(0, 100)}`);
    }
    return await res.json();
  }

  async function writeGist(pat, files) {
    const res = await proxy('PATCH', `https://api.github.com/gists/${gistId}`, {
      'Authorization': 'token ' + pat,
      'User-Agent': 'Z-ID-App',
      'Content-Type': 'application/json'
    }, { files });
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Gist (${res.status}): ${text.substring(0, 100)}`);
    }
    return await res.json();
  }

  // === –•–≠–®–ò–†–û–í–ê–ù–ò–ï ===
  async function hashPassword(password, salt = null) {
    if (!salt) {
      const arr = new Uint8Array(32);
      crypto.getRandomValues(arr);
      salt = Array.from(arr, b => b.toString(16).padStart(2, '0')).join('');
    }
    const enc = new TextEncoder();
    const key = await crypto.subtle.importKey('raw', enc.encode(password), { name: 'PBKDF2' }, false, ['deriveBits']);
    const bits = await crypto.subtle.deriveBits({
      name: 'PBKDF2',
      salt: enc.encode(salt),
      iterations: 100000,
      hash: 'SHA-256'
    }, key, 256);
    const hashArr = Array.from(new Uint8Array(bits));
    return { hash: hashArr.map(b => b.toString(16).padStart(2, '0')).join(''), salt };
  }

  // === –í–ê–õ–ò–î–ê–¶–ò–Ø Z ID ===
  function validateZID(zid) {
    if (zid.length !== 10 || !/^\d{10}$/.test(zid)) return false;
    const counts = {};
    for (let d of zid) {
      counts[d] = (counts[d] || 0) + 1;
      if (counts[d] > 3) return false;
    }
    return true;
  }

  function generateZID() {
    let zid;
    do {
      zid = '';
      const counts = {};
      for (let i = 0; i < 10; i++) {
        let d;
        do { d = Math.floor(Math.random() * 10).toString(); } while (counts[d] >= 3);
        zid += d;
        counts[d] = (counts[d] || 0) + 1;
      }
    } while (!validateZID(zid));
    return zid;
  }

  // === –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ===
  document.getElementById('btnRegister').addEventListener('click', async () => {
    const name = document.getElementById('regName').value.trim();
    const surname = document.getElementById('regSurname').value.trim();
    const patronymic = document.getElementById('regPatronymic').value.trim();
    let zid = document.getElementById('regZID').value.trim();
    const pass = document.getElementById('regPass').value;
    const birth = document.getElementById('regBirth').value;
    const nationality = document.getElementById('regNationality').value;
    const genderEl = document.querySelector('input[name="gender"]:checked');
    const gender = genderEl ? genderEl.value : '';
    const pat = document.getElementById('regPat').value.trim();

    // üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ "0" –∏ –ø—É—Å—Ç–æ—Ç—É
    if (!name || name === '0') { alert('‚ùó –ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º –∏–ª–∏ "0"'); return; }
    if (!surname || surname === '0') { alert('‚ùó –§–∞–º–∏–ª–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π –∏–ª–∏ "0"'); return; }
    if (!patronymic || patronymic === '0') { alert('‚ùó –û—Ç—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º –∏–ª–∏ "0"'); return; }
    if (!zid || !pat || !pass || !birth || !nationality || !gender) {
      alert('‚ùó –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è, –≤–∫–ª—é—á–∞—è PAT.');
      return;
    }

    if (!validateZID(zid)) {
      alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π Z ID. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 10 —Ü–∏—Ñ—Ä, –∫–∞–∂–¥–∞—è ‚â§3 —Ä–∞–∑.');
      return;
    }

    if (pass.length < 8 || pass.length > 20) {
      alert('‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 8‚Äì20 —Å–∏–º–≤–æ–ª–æ–≤.');
      return;
    }

    try {
      // –ß—Ç–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ Gist
      const gist = await readGist(pat);

      // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ Z ID
      for (let filename in gist.files) {
        if (filename === `zid_${zid}.json`) {
          const newZID = generateZID();
          if (confirm(`Z ID ${zid} —É–∂–µ –∑–∞–Ω—è—Ç. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π: ${newZID}?`)) {
            zid = newZID;
            document.getElementById('regZID').value = zid;
          } else {
            return;
          }
        }
      }

      const { hash, salt } = await hashPassword(pass);
      const account = {
        zid,
        name,
        surname,
        patronymic,
        password_hash: hash,
        salt,
        birth_date: birth,
        nationality,
        gender: ({male: '–ú—É–∂—Å–∫–æ–π', female: '–ñ–µ–Ω—Å–∫–∏–π', other: '–î—Ä—É–≥–æ–π'})[gender],
        created_at: new Date().toISOString()
      };

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
      await writeGist(pat, {
        [`zid_${zid}.json`]: { content: JSON.stringify(account, null, 2) }
      });

      alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Gist.');
      localStorage.setItem('currentZID', zid);
      localStorage.setItem('pat', btoa(pat));
      showProfile(account);
    } catch (e) {
      console.error(e);
      alert('‚ùå –û—à–∏–±–∫–∞:\n' + (e.message || e));
    }
  });

  // === –í–•–û–î ===
  document.getElementById('btnLogin').addEventListener('click', async () => {
    const zid = document.getElementById('loginZID').value.trim();
    const pass = document.getElementById('loginPass').value;

    if (!zid || !pass) {
      alert('‚ùó –í–≤–µ–¥–∏—Ç–µ Z ID –∏ –ø–∞—Ä–æ–ª—å.');
      return;
    }

    const pat = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à GitHub PAT (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è):');
    if (!pat) return;

    try {
      const gist = await readGist(pat);
      const filename = `zid_${zid}.json`;
      const file = gist.files[filename];
      if (!file) throw new Error('–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.');

      const account = JSON.parse(file.content);
      const { hash } = await hashPassword(pass, account.salt);
      if (hash !== account.password_hash) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.');

      localStorage.setItem('currentZID', zid);
      localStorage.setItem('pat', btoa(pat));
      showProfile(account);
    } catch (e) {
      console.error(e);
      alert('‚ùå ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
  });

  // === –ú–ï–ù–Æ –ü–†–û–§–ò–õ–Ø ===
  function showProfile(acc) {
    document.getElementById('displayZID').textContent = acc.zid;
    document.getElementById('displayName').value = acc.name;
    document.getElementById('displaySurname').value = acc.surname;
    document.getElementById('displayPatronymic').value = acc.patronymic;
    document.getElementById('displayBirth').value = new Date(acc.birth_date).toLocaleDateString('ru-RU');
    document.getElementById('displayNationality').value = acc.nationality;
    document.getElementById('displayGender').value = acc.gender;

    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('profileMenu').classList.remove('hidden');

    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ Z ID
    document.getElementById('copyZIDBtn').onclick = () => {
      navigator.clipboard.writeText(acc.zid).then(() => {
        const btn = document.getElementById('copyZIDBtn');
        btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        setTimeout(() => btn.textContent = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 2000);
      });
    };

    // –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
    document.getElementById('changePassBtn').onclick = () => {
      document.getElementById('passwordInputs').classList.remove('hidden');
    };

    document.getElementById('savePassBtn').onclick = async () => {
      const new1 = document.getElementById('newPass').value;
      const new2 = document.getElementById('newPass2').value;
      const resEl = document.getElementById('passResult');

      if (!new1 || new1.length < 8 || new1.length > 20) {
        resEl.textContent = '‚ùå –ü–∞—Ä–æ–ª—å 8‚Äì20 —Å–∏–º–≤–æ–ª–æ–≤';
        resEl.className = 'error';
        resEl.classList.remove('hidden');
        return;
      }
      if (new1 !== new2) {
        resEl.textContent = '‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
        resEl.className = 'error';
        resEl.classList.remove('hidden');
        return;
      }

      try {
        const pat = atob(localStorage.getItem('pat'));
        const { hash, salt } = await hashPassword(new1);
        acc.password_hash = hash;
        acc.salt = salt;

        await writeGist(pat, {
          [`zid_${acc.zid}.json`]: { content: JSON.stringify(acc, null, 2) }
        });

        resEl.textContent = '‚úÖ –ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω';
        resEl.className = 'success';
        resEl.classList.remove('hidden');
        setTimeout(() => {
          document.getElementById('passwordInputs').classList.add('hidden');
          resEl.classList.add('hidden');
        }, 2000);
      } catch (e) {
        resEl.textContent = '‚ùå ' + (e.message || '–û—à–∏–±–∫–∞');
        resEl.className = 'error';
        resEl.classList.remove('hidden');
      }
    };

    // –≠–∫—Å–ø–æ—Ä—Ç
    document.getElementById('exportBtn').onclick = () => {
      const safeData = {
        zid: acc.zid,
        name: acc.name,
        surname: acc.surname,
        patronymic: acc.patronymic,
        birth_date: acc.birth_date,
        nationality: acc.nationality,
        gender: acc.gender,
        created_at: acc.created_at,
        exported_at: new Date().toISOString()
      };

      const blob = new Blob([JSON.stringify(safeData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'reservedZID.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    };
  }

  // === –ö–ù–û–ü–ö–ê üé≤ ===
  document.getElementById('diceBtn').onclick = () => {
    document.getElementById('regZID').value = generateZID();
  };

  // === –í–ö–õ–ê–î–ö–ò ===
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      document.querySelectorAll('[id$="View"]').forEach(el => el.classList.add('hidden'));
      document.getElementById(tab.dataset.view + 'View').classList.remove('hidden');
    });
  });

  // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
  document.addEventListener('DOMContentLoaded', () => {
    const zid = localStorage.getItem('currentZID');
    const patB64 = localStorage.getItem('pat');
    if (zid && patB64) {
      const pat = atob(patB64);
      readGist(pat).then(gist => {
        const file = gist.files[`zid_${zid}.json`];
        if (file) showProfile(JSON.parse(file.content));
      }).catch(() => {});
    }
  });
</script>
</body>
</html>
